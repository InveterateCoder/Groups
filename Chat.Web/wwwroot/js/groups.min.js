var app,notif_worker;navigator.serviceWorker.register("/js/notif_worker.js").then(e=>notif_worker=e),document.addEventListener("DOMContentLoaded",()=>app=new app_class);class api_class{constructor(){}async register(e){try{let s=!1,n=await this.post("/api/account/reg",e);return n==="pending_"+e.email?s=!0:"signed_out"===n?app.alert("You've been signed out, try again"):"email_is_taken"===n?app.alert("This email address has been already registered"):"invalid_name"===n?app.alert("Name cannot contain following characters: \\/:*?\"<>|&%#[]+=\u201E\u201C"):"name_is_taken"===n?app.alert("This nickname has been already taken"):app.alert(n),s}catch(e){return app.alert(e.message),!1}}async validate(e){try{let s=!1,n=await this.post("api/account/val",e);return n.startsWith("added_")?s=!0:"signed_out"==n?app.alert("You've been signed out, try again"):"invalid_confirmation_id"==n?app.alert("Wrong number"):"reg_request_required"==n?app.alert("Registration is required prior to email verification"):"email_is_taken"==n?app.alert("This email address has been already registered"):"name_is_taken"==n?app.alert("This nickname has been already taken"):app.alert(n),s}catch(e){return app.alert(e.message),!1}}async signin(e){try{let s=!1,n=await this.post("api/account/sign",e);return"OK"==n?s=await this.usr_info():"signed_out"==n?app.alert("You've been signed out, try again"):"user_not_found"==n?app.alert("The email address is not registered"):"password_incorrect"==n?app.alert("Wrong password"):"multiple_signins_forbidden"==n?app.alert("Access denied, connection is already open"):app.alert(n),s}catch(e){return app.alert(e.message),!1}}async signout(){try{let e=!1,s=await this.post("api/user/signout");return"OK"==s||"not_authorized"==s||"single_connection_only"==s?e=!0:app.alert(s),e}catch(e){return app.alert(e.message),!1}}async acc_change(e){try{let s={name:!1,pass:!1},n=await this.post("api/user/change",e);return"name_changed"===n?(s.name=!0,app.name=e.NewName):"pass_changed"===n?s.pass=!0:"name&pass_changed"===n?(s.name=!0,s.pass=!0,app.name=e.NewName):"invalid_name"===n?app.alert("New name cannot contain following characters: \\/:*?\"<>|&%#[]+=\u201E\u201C"):"wrong_password"===n?app.alert("Wrong password"):"name_exists"===n?app.alert("The name is already taken, choose another one"):"no_change_requested"===n?app.alert("Empty request"):"same_credentials"===n?app.alert("No changes have been made, same credentials"):"not_authorized"===n||"single_connection_only"===n?s.pass=!0:app.alert(n),s}catch(e){return app.alert(e.message),!1}}async acc_delete(e){try{let s=!1,n=await this.post("api/user/del",e);switch(n){case"deleted":s=!0;break;case"wrong_email":app.alert("Wrong email address");break;case"wrong_password":app.alert("Wrong password");break;case"not_authorized":case"single_connection_only":break;default:app.alert(n);}return s}catch(e){return app.alert(e.message),!1}}async grp_reg(e){try{let s=!1,n=await this.post("api/groups/reg",e);return"OK"===n?(app.group=e.GroupName,s=!0):"has_group"===n?app.alert("You have already registered a group"):"invalid_name"===n?app.alert("Group name cannot contain following characters: \\/:*?\"<>|&%#[]+=\u201E\u201C"):"name_taken"===n?app.alert("A group with such name already exists"):"not_authorized"===n||"single_connection_only"===n?s=!0:app.alert(n),s}catch(e){return app.alert(e.message),!1}}async grp_change(e){try{let s=!1,n=await this.post("api/groups/change",e);switch(n){case"name_changed":case"name&pass_changed":app.group=e.NewGroupName;case"pass_changed":case"not_authorized":case"single_connection_only":s=!0;break;case"has_no_group":app.group=null,s=!0;break;case"wrong_password":app.alert("Wrong password");break;case"invalid_name":app.alert("New group name cannot contain following characters: \\/:*?\"<>|&%#[]+=\u201E\u201C");break;case"group_name_exists":app.alert("The group name is already taken, choose another one");break;case"not_changed":app.alert("No changes were made");break;case"no_change_requested":app.alert("No change was requested");break;default:app.alert(n);}return s}catch(e){return app.alert(e.message),!1}}async usr_info(){try{let e=!1,s=await fetch("api/user/info",{method:"get",headers:{Accept:"application/json"}});if(200!=s.status)app.name=null,app.group=null,app.ingroup=null,app.goto("reg");else{let n=await s.json();null==n.name?app.name=null:(app.name=n.name,e=!0),app.group=null==n.group?null:n.group,app.ingroup=null==n.ingroup?null:n.ingroup,app.pub_key=n.pub_key}return e}catch(e){return app.alert(e.message),!1}}async grp_del(e){try{let s=!1,n=await this.post("api/groups/del",e);switch(n){case"deleted":case"has_no_group":app.group=null,s=!0;break;case"wrong_password":app.alert("Wrong password");break;case"not_authorized":case"single_connection_only":break;default:app.alert(n);}return s}catch(e){return app.alert(e.message),!1}}async list_groups(e,s,n){let t=null;if(0!=e&&!e||isNaN(e)||0>e)return null;if(!s&&0!=s)t=await this.get(`api/groups/list/${e}`);else{if(isNaN(s)||1>s||100<s)return null;if(!n&&0!=n)t=await this.get(`api/groups/list/${e}/${s}`);else{if(64<n.length)return null;t=await this.get(`api/groups/list/${e}/${s}/${n}`)}}return t}async grp_signin(e){let s={success:!1,hide:!1};try{let n=await this.post("api/groups/sign",e);return"OK"===n?(app.ingroup=e.name,s.success=!0):"already_signed"===n?(s.hide=!0,app.alert("Already signed into a group, please sign out to proceed")):"not_found"===n?(s.hide=!0,app.alert("Group doesn't exist")):"wrong_password"===n?app.alert("Wrong group password, try again"):app.alert(n),s}catch(e){return app.alert(e.message),!1}}async get_grp_msgs(e,s){try{let n=+e;return 0!=n&&n<app.groupin.jsMsToTicks(Date.now()-1296e6)?null:1>s||100<s?null:await this.get(`api/groups/msgs/${e}/${s}`)}catch(e){return app.alert(e),null}}async get_missed_msgs(e){try{return+e<app.groupin.jsMsToTicks(Date.now()-864e5)?null:await this.get(`api/groups/msgs/missed/${e}`)}catch(e){return app.alert(e),null}}async subscribe(e){try{let s=await this.post("api/push/web/subscribe",e);return!("OK"!=s)||(app.alert(s),!1)}catch(e){return app.alert(e.message),!1}}async unsubscribe(){try{app.wait();let e,s=await fetch("api/push/web/unsubscribe",{method:"get",headers:{Accept:"text/plain"}});return(app.resume(),200!=s.status)?(app.fail("Error. Server responded with: "+s.statusText),!1):(e=await s.text(),"OK"==e||(app.alert(e),!1))}catch(e){return app.alert(e.message),!1}}async push(e){try{let s=!1,n=await this.post("api/push/web/push",e);switch(n){case"OK":s=!0;break;case"not_in_group":app.alert("You must be signed to a group.");break;case"s_not_subscribed":app.alert("You must be subscribed for notifications.");break;case"not_found":app.alert("User was not found.");break;case"not_same_group":app.alert("User is not in the same group.");break;case"r_not_subscribed":app.alert("User is not subscribed for notifications.");break;case"is_notified_hour":app.alert("User has been already invited. Active one hour policy. Please try later.");break;case"usr_active":app.alert("User is online and cannot be invited.");break;default:app.alert(n);}return s}catch(e){return app.alert(e.message),!1}}async post(e,s){app.wait();let n;try{let t=await fetch(e,{method:"post",headers:{Accept:"text/plain","Content-Type":"application/json"},body:JSON.stringify(s||"")});200==t.status?n=await t.text():(app.fail("Error. Server responded with: "+t.statusText),n=null)}catch(e){n=e.message}finally{return app.resume(),n}}async get(e){app.wait();let s;try{let n=await fetch(e,{method:"get",headers:{Accept:"application/json"}});200==n.status?s=await n.json():(app.fail("Error. Server responded with: "+n.statusText),s=null)}catch(e){s.response=e.message}finally{return app.resume(),s}}}class reg_panel_class{constructor(){this.panel=document.getElementById("reg_panel"),this.place="home";this.email=null,this.password=null}num(s){isNaN(s.key)&&s.preventDefault()}pasteFilter(s){isNaN(s.target.value)&&(s.target.value=null)}clear(){let e;switch(this.place){case"reg":e=this.panel.children[2].getElementsByTagName("input");for(let s=0;s<e.length;s++)e[s].value=null;break;case"sign":e=this.panel.children[3].getElementsByTagName("input");for(let s=0;s<e.length;s++)e[s].value=null;break;case"numb":this.panel.children[4].getElementsByTagName("input")[0].value=null;}}btn_hover(e){e.firstElementChild.style.transform="scale(1.1,1.1)"}btn_out(e){e.firstElementChild.style.transform="scale(1,1)"}btn_down(e){e.firstElementChild.style.transform="scale(0.9,0.9)"}btn_up(e){e.firstElementChild.style.transform="scale(1.1,1.1)"}goto(e){"home"===e?(this.hide(),this.panel.children[1].style.display="flex",this.place=e):"reg"===e?(this.hide(),this.panel.children[2].style.display="flex",this.panel.children[2].children[1].children[1].focus(),this.place=e):"sign"===e?(this.hide(),this.panel.children[3].style.display="flex",this.panel.children[3].children[1].children[1].focus(),this.place=e):"numb"===e?(this.hide(),this.panel.children[4].style.display="flex",this.panel.children[4].children[1].firstElementChild.focus(),this.place=e):void 0}hide(){switch(this.place){case"home":this.panel.children[1].style.display="none";break;case"reg":this.clear(),this.panel.children[2].style.display="none";break;case"sign":this.clear(),this.panel.children[3].style.display="none";break;case"numb":this.clear(),this.panel.children[4].style.display="none";}}register(){let e=this.panel.children[2].getElementsByTagName("input"),s={name:e[0].value,email:e[1].value,password:e[2].value};app.validateName(s.name)?s.email&&e[1].checkValidity()?app.validatePassword(s.password)?app.api.register(s).then(e=>{e&&(this.email=s.email,this.password=s.password,this.goto("numb"))}):app.alert(app.message.password("Password")):app.alert("Incorrect email address"):app.alert(app.message.name("Name"))}validate(){let e=this.panel.children[4].getElementsByTagName("input")[0].value;4==e.length?app.api.validate(+e).then(e=>{if(e){this.goto("sign");let e=this.panel.children[3].getElementsByTagName("input");e[0].value=this.email,e[1].value=this.password,this.email=this.password=null,this.signin()}}):app.alert("Code must consist of 4 digits")}signin(){let e=this.panel.children[3].getElementsByTagName("input"),s={email:e[0].value,password:e[1].value};s.email&&e[0].checkValidity()?app.validatePassword(s.password)?app.api.signin(s).then(e=>{e&&(app.ingroup?app.goto("ingroup"):app.goto("groups"))}):app.alert(app.message.password("Password")):app.alert("Incorrect email address")}cntrl_key(e){if("Enter"==e)switch(this.place){case"reg":this.register();break;case"sign":this.signin();break;case"numb":this.validate();}else"Escape"==e&&"home"!=this.place&&this.goto("home")}}class groups_class{constructor(){this.groups_window=document.getElementById("groups"),this.hmbrgr_btn=document.getElementById("hmbrgr"),this.m_acc=document.getElementById("m_account"),this.m_group=document.getElementById("m_group"),this.m_all=document.getElementById("m_all"),this.account_btn=this.groups_window.children[2].children[2].children[0].children[0],this.group_btn=this.groups_window.children[2].children[2].children[0].children[1],this.acc_open=!1,this.group_open=!1,this.groups_forms=document.getElementById("groups_forms"),this.start=0,this.quantity=100,this.query="",this.timeoutHandle=null,this.open_form=null}hmbrg_click(){this.hmbrgr_btn.classList.toggle("clicked"),this.hmbrgr_btn.classList.contains("clicked")?(this.m_all.style.opacity="1",this.m_all.style.transform="translate(0,0)"):(this.m_all.style.opacity="0",this.m_all.style.transform=`translate(0, -${this.m_all.offsetHeight}px)`)}hmbrg_over(){for(let e=0;e<this.hmbrgr_btn.children.length;e++)this.hmbrgr_btn.children[e].style.backgroundColor="white",this.hmbrgr_btn.children[e].style.boxShadow="0 0 4px white"}hmbrg_out(){for(let e=0;e<this.hmbrgr_btn.children.length;e++)this.hmbrgr_btn.children[e].style.backgroundColor="silver",this.hmbrgr_btn.children[e].style.boxShadow="none"}initialize(e=!0){this.close_all_menus();let s=this.groups_window.children[2].offsetHeight;this.groups_window.children[0].style.top=s+"px",this.m_acc.style.right="0px",this.m_acc.style.top=s+"px",this.m_acc.style.width=this.account_btn.offsetWidth+28+"px",this.m_group.style.right=this.m_acc.offsetWidth+"px",this.m_group.style.top=s+"px",this.m_group.style.width=this.group_btn.offsetWidth+28+"px",e&&this.group_conf(),this.m_all.style.top=this.groups_window.children[2].offsetHeight+"px",this.m_all.style.transform=`translate(0, -${this.m_all.offsetHeight}px)`}group_conf(){app.group?(this.m_group.children[0].style.display="none",this.m_group.children[1].textContent=app.group,this.m_group.children[1].title=app.group,this.m_group.children[1].style.display="list-item",this.m_group.children[2].style.display="list-item",this.m_group.children[3].style.display="list-item",this.m_all.children[5].style.display="none",this.m_all.children[6].textContent=app.group,this.m_all.children[6].title=app.group,this.m_all.children[6].style.display="block",this.m_all.children[7].style.display="block",this.m_all.children[8].style.display="block"):(this.m_group.children[0].style.display="list-item",this.m_group.children[1].style.display="none",this.m_group.children[2].style.display="none",this.m_group.children[3].style.display="none",this.m_all.children[5].style.display="block",this.m_all.children[6].style.display="none",this.m_all.children[7].style.display="none",this.m_all.children[8].style.display="none")}m_accf(){this.m_proc(this.m_acc,this.account_btn,this.acc_open,!0)}m_groupf(){this.m_proc(this.m_group,this.group_btn,this.group_open)}m_proc(e,s,n,t=!1){n?(s.classList.remove("open"),t?this.acc_open=!1:this.group_open=!1,e.style.opacity="0",e.style.visibility="hidden"):(s.classList.add("open"),e.style.visibility="visible",e.style.opacity="1",e.focus(),t?this.acc_open=!0:this.group_open=!0)}m_onblur(e){e.style.opacity="0","m_account"==e.id?this.account_btn.classList.remove("open"):this.group_btn.classList.remove("open"),setTimeout(()=>{"m_account"==e.id?(this.acc_open=!1,this.m_acc.style.visibility="hidden"):(this.group_open=!1,this.m_group.style.visibility="hidden")},170)}close_all_menus(){this.acc_open?(this.account_btn.classList.remove("open"),this.acc_open=!1,this.m_acc.style.opacity="0",this.m_acc.style.visibility="hidden"):this.group_open&&(this.group_btn.classList.remove("open"),this.group_open=!1,this.m_group.style.opacity="0",this.m_group.style.visibility="hidden"),this.hmbrgr_btn.classList.contains("clicked")&&(this.hmbrgr_btn.classList.remove("clicked"),this.m_all.style.opacity="0",this.m_all.style.transform=`translate(0, -${this.m_all.offsetHeight}px)`)}groups_resize(){this.initialize(!1),this.groups_window.firstElementChild.scrollHeight-this.groups_window.firstElementChild.scrollTop<window.innerHeight+300&&this.list_load()}signout(){this.close_all_menus(),app.api.signout().then(e=>{e&&(app.goto("reg"),app.name=null,app.group=null)})}form_open(e){this.open_form=e,this.groups_forms.children[e].style.display="flex",this.groups_forms.style.display="block",this.close_all_menus()}form_close(e){this.open_form=null,this.groups_forms.style.display="none",this.groups_forms.children[e].style.display="none";let s=this.groups_forms.children[e].getElementsByTagName("input");if(4==e){this.groups_forms.children[4].children[4].style.visibility="visible",s[2].checked=!1;for(let e=0;e<s.length;e++)2!=e&&(s[e].value=null)}else for(let e=0;e<s.length;e++)s[e].value=null}acc_change(){let e=this.groups_forms.children[1].getElementsByTagName("input"),s={Password:e[0].value,NewName:e[1].value,NewPassword:e[2].value};app.validatePassword(s.Password)?0<s.NewName.length&&!app.validateName(s.NewName)?app.alert(app.message.name("New name")):s.NewPassword&&!app.validatePassword(s.NewPassword)?app.alert(app.message.password("New password")):s.Password==s.NewPassword||s.NewName==app.name?app.alert("Leave blank if the credentials are the same"):s.NewName||s.NewPassword?(0==s.NewName.length&&(s.NewName=null),0==s.NewPassword.length&&(s.NewPassword=null),app.api.acc_change(s).then(e=>{(e.name||e.pass)&&(e.name&&(this.groups_window.getElementsByTagName("code")[0].textContent=app.name),this.form_close(1))})):app.alert("No change requested"):app.alert(app.message.password("Password"))}acc_delete(){let e=this.groups_forms.children[2].getElementsByTagName("input"),s={email:e[0].value,password:e[1].value};s.email&&e[0].checkValidity()?app.validatePassword(s.password)?app.api.acc_delete(s).then(e=>{e&&(app.goto("reg"),app.name=null,app.group=null,this.form_close(2))}):app.alert(app.message.password("Password")):app.alert("Incorrect email address")}group_create(){let e=this.groups_forms.children[3].getElementsByTagName("input"),s={Password:e[0].value,GroupName:e[1].value,GroupPassword:e[2].value};app.validatePassword(s.Password)?app.validateName(s.GroupName)?s.GroupPassword&&!app.validatePassword(s.GroupPassword)?app.alert(app.message.password("Group password")):(0==s.GroupPassword.length&&(s.GroupPassword=null),app.api.grp_reg(s).then(e=>{e&&(this.group_conf(),this.list_clear(),this.form_close(3),this.list_load())})):app.alert(app.message.name("Group name")):app.alert(app.message.password("Password"))}group_change(){let e=this.groups_forms.children[4].getElementsByTagName("input"),s={Password:e[0].value,NewGroupName:e[1].value,NewGroupPassword:e[3].value};app.validatePassword(s.Password)?0<s.NewGroupName.length&&!app.validateName(s.NewGroupName)?app.alert(app.message.name("New name")):e[2].checked||!s.NewGroupPassword||app.validatePassword(s.NewGroupPassword)?(e[2].checked?s.NewGroupPassword=null:0==s.NewGroupPassword.length&&(s.NewGroupPassword="000"),0==s.NewGroupName.length&&(s.NewGroupName=null),s.NewGroupName||"000"!=s.NewGroupPassword?app.api.grp_change(s).then(e=>{e&&(this.group_conf(),this.list_clear(),this.form_close(4),this.list_load())}):app.alert("No change requested")):app.alert(app.message.password("New password")):app.alert(app.message.password("Password"))}group_del(){let e=this.groups_forms.children[5].getElementsByTagName("input")[0].value;app.validatePassword(e)?app.api.grp_del(e).then(e=>{e&&(this.group_conf(),this.list_clear(),this.form_close(5),this.list_load())}):app.alert(app.message.password("Password"))}on_pass_del_change(e){this.groups_forms.children[4].children[4].style.visibility=e.checked?"hidden":"visible"}list_clear(){let e=this.groups_window.firstElementChild;if(0<e.childElementCount)for(;e.firstElementChild;)e.firstElementChild.remove();this.start=0,this.quantity=100}list_add(e){if(!e||!Array.isArray(e)||0==e.length)return!1;let s=this.groups_window.firstElementChild;e.forEach(e=>{if("string"==typeof e){let t=document.createElement("button");var n=document.createTextNode(e);t.appendChild(n),t.onclick=()=>app.groups.group_signin(e),t.tabIndex=-1,s.appendChild(t)}})}list_load(){0<this.quantity&&app.api.list_groups(this.start,this.quantity,this.query).then(e=>{0==e?this.quantity=0:"string"==typeof e?app.alert(e):Array.isArray(e)&&(this.start+=e.length,e.length<this.quantity&&(this.quantity=0),this.list_add(e),this.groups_window.firstElementChild.scrollHeight<window.innerHeight+300&&this.list_load())})}on_scroll(e){e.scrollTop+e.clientHeight>e.scrollHeight-300&&this.list_load()}on_query_key(e){this.list_clear(),this.set_list_timer(e)}on_query_paste(s){this.list_clear(),this.set_list_timer(s.clipboardData.getData("Text"))}on_query_cut(e){setTimeout(()=>{this.list_clear(),this.set_list_timer(e.value)},50)}set_list_timer(e){e!=this.query&&(this.query=e,clearTimeout(this.timeoutHandle),this.timeoutHandle=setTimeout(()=>{this.list_load(),setTimeout(()=>this.groups_window.children[2].children[1].focus(),100)},500))}group_signin(e){if(e&&e==app.group)this.close_all_menus(),this.group_signin_send({name:e,password:null});else{let s=this.groups_forms.children[6].getElementsByTagName("input");s[0].value=e,this.form_open(6)}}group_signin_send(e=null){if(!e){let s=this.groups_forms.children[6].getElementsByTagName("input");e={name:s[0].value,password:s[1].value}}app.validateName(e.name)?e.password&&!app.validatePassword(e.password)?app.alert(app.message.password("Group password")):(!e.password&&(e.password=null),app.api.grp_signin(e).then(e=>{e.success?("none"!=this.groups_forms.children[6].style.display&&this.form_close(6),app.goto("ingroup")):e.hide&&(this.list_clear(),this.list_load(),"none"!=this.groups_forms.children[6].style.display&&this.form_close(6))})):app.alert(app.message.name("Group name"))}cntrl_key(e){"Enter"==e?this.open_form&&this.groups_forms.children[this.open_form].lastElementChild.lastElementChild.click():"Escape"==e&&(this.open_form?this.groups_forms.children[this.open_form].lastElementChild.firstElementChild.click():this.close_all_menus())}}class ingroup_class{constructor(){this.dicon_cover=document.querySelector("#ingroup > #disconnected"),this.msgs_panel=document.getElementById("ingroup").firstElementChild,this.msgs_panel.addEventListener("click",()=>app.groupin.usrs_close(),!0),this.msgs_cont=this.msgs_panel.children[1],this.msg_input=document.querySelector("#ingroup > div:first-child > input"),this.usrs_panel=this.msgs_panel.nextElementSibling,this.secret_input=this.usrs_panel.firstElementChild.firstElementChild,this.open_btn=this.msgs_panel.firstElementChild.firstElementChild,this.close_btn=this.usrs_panel.firstElementChild.children[1],this.connection=new signalR.HubConnectionBuilder().withUrl("/hub").configureLogging(signalR.LogLevel.Error).build(),this.connection.onclose(()=>this.leave()),this.connection.on("signed_out",e=>this.member_signout(e)),this.connection.on("go_off",e=>this.usr_switch_off(e)),this.connection.on("go_on",e=>this.usr_joined(e)),this.connection.on("message_client",e=>this.recieve_msg(e)),this.isMobile=!1,this.usrs_panel_open=!0,this.offl_usr=null,this.onl_usrs=new Set,this.btn_swtch=this.usrs_panel.children[2].firstElementChild,this.btn_notif=this.btn_swtch.nextElementSibling,this.btn_sound=this.btn_notif.nextElementSibling,this.is_cleared=!1,this.onl_usr_panel=this.usrs_panel.children[3].firstElementChild,this.ofl_usr_panel=this.usrs_panel.children[3].children[2],this.arr_onl_usrs=null,this.arr_ofl_usrs=null,this.signingout=!1,this.open_peers=null,this.upper_msg_el=null,this.upper_msg_time="0",this.last_msg_time=null,this.end_reached=!1,this.msgs_quantity=30,this.isdown=!0,this.scroll_handle=null,this.block_scroll=!1,this.resize_handle=null,this.usr_state_changed=!1,this.msgs_loaded=!1,this.msg_pipe_handle=null,this.msg_pipe=[],this.msg_time=new Set,this.key=null,this.recieve_msg_mutex=!1,this.encoder=new TextEncoder,this.decoder=new TextDecoder,this.audio=document.createElement("audio");let e=document.createElement("source");e.setAttribute("src","sounds/new_m.mp3"),e.setAttribute("type","audio/mpeg"),this.audio.appendChild(e),this.sound_on=!1}get secret(){let e=localStorage.getItem("secret");return e?e:""}set secret(e){e?localStorage.setItem("secret",e):localStorage.removeItem("secret")}init(){if(this.dicon_cover.style.opacity="0",setTimeout(()=>app.groupin.dicon_cover.style.display="none",500),this.config_mobile(),this.members_get(),!this.last_msg_time){this.secret_input.value="";let e=this.secret;if(e)for(let s=0;s<e.length;s++)this.secret_input.value+="-";!this.key&&e?this.toCryptoKey(this.secret).then(e=>{this.key=e,this.get_msgs(!0)}):this.get_msgs(!0)}else this.get_missed_msgs(this.last_msg_time)}leave(e=!1){this.msg_input.setAttribute("disabled",""),this.dicon_cover.style.display="block",this.dicon_cover.style.opacity="1",this.usr_state_changed=!1,this.clear_usrs(),this.msgs_loaded=!1,e&&(this.msg_input.value=null,this.clear_msgs(),this.key=null,this.secret_input.value="")}async members_get(){let e=JSON.parse((await this.connection.invoke("Members")));Array.isArray(e.online)&&Array.isArray(e.offline)?(this.arr_onl_usrs=e.online,this.arr_ofl_usrs=e.offline,this.arr_onl_usrs.splice(this.arr_onl_usrs.indexOf(app.name),1),this.arr_onl_usrs.sort(),this.arr_onl_usrs.forEach(e=>this.onl_usr_panel.appendChild(this.create_name(e,!0))),this.arr_ofl_usrs.sort(),this.arr_ofl_usrs.forEach(e=>{this.ofl_usr_panel.appendChild(this.create_name(e,!1))}),this.usr_state_changed&&(this.usr_state_changed=!1,this.clear_usrs(),this.members_get())):(this.signout(),app.alert("Something went terribly wrong: "+e))}clear_usrs(){this.arr_onl_usrs=null,this.arr_ofl_usrs=null,this.offl_usr=null,this.onl_usrs.clear(),this.is_cleared=!1;let e=this.onl_usr_panel;this.onl_usr_panel=document.createElement("div"),this.onl_usr_panel.setAttribute("id","online_usrs"),e.parentElement.replaceChild(this.onl_usr_panel,e),e.remove(),e=this.ofl_usr_panel,this.ofl_usr_panel=document.createElement("div"),this.ofl_usr_panel.setAttribute("id","offline_usrs"),e.parentElement.replaceChild(this.ofl_usr_panel,e),e.remove(),this.btn_swtch.firstElementChild.src="/images/cancel_sel.svg",this.btn_swtch.classList.add("disabled"),this.btn_notif.classList.add("disabled")}clear_msgs(){let e=this.msgs_cont;this.msgs_cont=document.createElement("div"),this.msgs_cont.setAttribute("onscroll","app.groupin.scroll()"),e.parentElement.replaceChild(this.msgs_cont,e),e.remove(),this.end_reached=!1,this.last_msg_time=null,this.upper_msg_time="0",this.upper_msg_el=null,this.msgs_cont.style.opacity="0"}ingroup_resize(){this.msgs_cont.style.opacity="0",this.config_mobile(),this.usrs_close(),this.isdown?(this.block_scroll=!0,clearTimeout(this.resize_handle),this.resize_handle=setTimeout(()=>{app.groupin.block_scroll=!1,app.groupin.msgs_cont.scrollTop=app.groupin.msgs_cont.scrollHeight,app.groupin.msgs_cont.style.opacity="1"},300)):(clearTimeout(this.resize_handle),this.resize_handle=setTimeout(()=>{app.groupin.msgs_cont.style.opacity="1"},300))}config_mobile(){this.isMobile&&900<window.innerWidth?(this.isMobile=!1,this.usrs_open(),this.open_btn.style.display=this.close_btn.style.display="none",this.open_btn.style.opacity=this.close_btn.style.opacity="0"):!this.isMobile&&900>=window.innerWidth&&(this.isMobile=!0,this.usrs_close(),this.open_btn.style.display=this.close_btn.style.display="block",this.open_btn.style.opacity="1",setTimeout(()=>this.close_btn.style.opacity="1",400))}usrs_close(){this.isMobile&&this.usrs_panel_open&&(this.usrs_panel_open=!1,this.usrs_panel.style.transform=`translateX(-${this.usrs_panel.offsetWidth||300}px)`)}usrs_open(){this.usrs_panel_open||(this.usrs_panel_open=!0,this.usrs_panel.style.transform=`translateX(0)`)}signout(){this.connection.invoke("SignOut").then(()=>app.goto("groups")).catch(e=>app.alert(e.message))}offl_usr_select(e){null==this.offl_usr?(this.offl_usr=e,e.classList.add("selected"),this.btn_notif.classList.remove("disabled")):this.offl_usr==e?(this.offl_usr=null,e.classList.remove("selected"),this.btn_notif.classList.add("disabled")):(this.offl_usr.classList.remove("selected"),this.offl_usr=e,e.classList.add("selected"))}onl_usr_select(e){this.is_cleared?(this.onl_usrs.clear(),this.btn_swtch.firstElementChild.src="/images/cancel_sel.svg",this.onl_usrs.add(e),e.classList.add("selected"),this.is_cleared=!1):this.onl_usrs.has(e)?(this.onl_usrs.delete(e),e.classList.remove("selected"),0==this.onl_usrs.size&&this.btn_swtch.classList.add("disabled")):(0==this.onl_usrs.size&&this.btn_swtch.classList.remove("disabled"),this.onl_usrs.add(e),e.classList.add("selected"))}switch_click(){0!=this.onl_usrs.size&&(this.is_cleared?(this.onl_usrs.forEach(e=>e.classList.add("selected")),this.is_cleared=!1,this.btn_swtch.firstElementChild.src="/images/cancel_sel.svg"):(this.onl_usrs.forEach(e=>e.classList.remove("selected")),this.is_cleared=!0,this.btn_swtch.firstElementChild.src="/images/selective.svg"))}create_name(e,s){let n=document.createElement("div");return n.textContent=e,n.setAttribute("onclick",s?"app.groupin.onl_usr_select(this)":"app.groupin.offl_usr_select(this)"),n}usr_joined(e){if(this.usr_state_changed=!0,!this.arr_onl_usrs)return;let s=this.arr_onl_usrs.indexOf(e);-1<s||(s=this.arr_ofl_usrs.indexOf(e),-1<s&&(this.offl_usr&&e==this.offl_usr.textContent&&(this.offl_usr=null,this.btn_notif.classList.add("disabled")),this.arr_ofl_usrs.splice(s,1),this.ofl_usr_panel.children[s].remove()),this.arr_onl_usrs.push(e),this.arr_onl_usrs.sort(function(e,s){return e.toLowerCase()<s.toLowerCase()?-1:e.toLowerCase()>s.toLowerCase()?1:0}),s=this.arr_onl_usrs.indexOf(e),this.onl_usr_panel.insertBefore(this.create_name(e,!0),this.onl_usr_panel.children[s]))}usr_switch_off(e){if(this.usr_state_changed=!0,!this.arr_onl_usrs)return;if(this.signingout)return void(this.signingout=!1);let s=this.arr_onl_usrs.indexOf(e);this.arr_onl_usrs.splice(s,1),this.remove_el(this.onl_usr_panel.children[s]),this.arr_ofl_usrs.push(e),this.arr_ofl_usrs.sort(function(e,s){return e.toLowerCase()<s.toLowerCase()?-1:e.toLowerCase()>s.toLowerCase()?1:0}),s=this.arr_ofl_usrs.indexOf(e),this.ofl_usr_panel.insertBefore(this.create_name(e,!1),this.ofl_usr_panel.children[s])}member_signout(e){if(this.usr_state_changed=!0,!!this.arr_onl_usrs){let s=this.arr_onl_usrs.indexOf(e);-1<s&&(this.arr_onl_usrs.splice(s,1),this.remove_el(this.onl_usr_panel.children[s])),this.signingout=!0}}remove_el(e){this.onl_usrs.has(e)&&(1==this.onl_usrs.size?(!0==this.is_cleared&&(this.is_cleared=!1,this.btn_swtch.firstElementChild.src="/images/cancel_sel.svg"),this.btn_swtch.classList.add("disabled"),this.onl_usrs.clear()):this.onl_usrs.delete(e)),e.remove()}jsMsToTicks(e){return 621355968e9+1e4*e}ticksToJsMs(e){return(e-621355968e9)/1e4}form_time(e){let s,n,t,r,l;return 0==e?n=t=r=l="--":(s=new Date(e),n=s.getMonth().toString(),2>n.length&&(n="0"+n),t=s.getDate().toString(),2>t.length&&(t="0"+t),r=s.getHours().toString(),2>r.length&&(r="0"+r),l=s.getMinutes().toString(),2>l.length&&(l="0"+l)),t+"/"+n+" "+r+":"+l}form_msg(e){let s=document.createElement("div");if(s.classList.add("message"),s.appendChild(document.createElement("div")),s.appendChild(document.createElement("div")),s.firstElementChild.appendChild(document.createElement("img")),s.firstElementChild.appendChild(document.createElement("div")),s.firstElementChild.appendChild(document.createElement("div")),s.firstElementChild.appendChild(document.createElement("div")),s.firstElementChild.children[1].textContent=this.form_time(e.jsTime),e.peers){s.firstElementChild.firstElementChild.src="/images/reply.svg",s.firstElementChild.firstElementChild.setAttribute("draggable","false"),s.firstElementChild.firstElementChild.setAttribute("onclick","app.groupin.reply_click(this)"),s.firstElementChild.firstElementChild.classList.add("reply"),s.firstElementChild.children[2].textContent="Secret",s.firstElementChild.children[2].classList.add("secret"),s.firstElementChild.children[2].setAttribute("onclick","app.groupin.show_peers(this)");let n=document.createElement("ul");e.peers.forEach(e=>{let s=document.createElement("li");s.textContent=e,n.appendChild(s)}),s.appendChild(n)}else s.firstElementChild.firstElementChild.src="/images/message.svg",s.firstElementChild.firstElementChild.setAttribute("draggable","false"),s.firstElementChild.children[2].textContent="Public";return s.firstElementChild.children[3].textContent=e.from,s.children[1].textContent=e.text,s}async recieve_msg(e){this.recieve_msg_mutex?setTimeout(()=>app.groupin.recieve_msg(e),10):(this.recieve_msg_mutex=!0,this.msgs_loaded?(this.sound_on&&this.audio.play(),!e.peers&&(this.last_msg_time=e.stringTime),this.key&&(e.text=await this.decrypt(e.text)),this.msgs_cont.appendChild(this.form_msg(e)),this.recieve_msg_mutex=!1,this.isdown&&(this.msgs_cont.scrollTop=this.msgs_cont.scrollHeight)):(this.msg_pipe.push(e),this.recieve_msg_mutex=!1,this.proc_pipe_msgs()))}async proc_pipe_msgs(){if(!app.groupin.msgs_loaded)clearTimeout(app.groupin.msg_pipe_handle),app.groupin.msg_pipe_handle=setTimeout(app.groupin.proc_pipe_msgs,50);else{for(let e,s=0;s<app.groupin.msg_pipe.length;s++)e=app.groupin.msg_pipe[s],app.groupin.msg_time.has(e.stringTime)||(await app.groupin.recieve_msg(e));app.groupin.msg_pipe.length=0,app.groupin.msg_time.clear(),app.groupin.msg_input.removeAttribute("disabled")}}onkey_input(e){if("Enter"==e.key&&this.msg_input.value){if(2500<this.msg_input.value.length)return this.msg_input.value="",void app.alert("Message size is limited to 2500 characters");var s=null;if(0==this.onl_usrs.size||!0==this.is_cleared)s={to:null,text:this.msg_input.value};else{let e=[];this.onl_usrs.forEach(s=>e.push(s.textContent)),s={to:e,text:this.msg_input.value}}this.msg_input.value=null;let e={jsTime:0,from:app.name,peers:s.to,text:s.text};this.last_sent_message=this.form_msg(e),this.msgs_cont.appendChild(this.last_sent_message),this.msgs_cont.scrollTop=this.msgs_cont.scrollHeight,this.key?this.encrypt(s.text).then(e=>{s.text=e,this.send_msg(s)}):this.send_msg(s)}else"Escape"==e.key&&this.msg_input.blur()}send_msg(e){this.connection.invoke("MessageServer",e).then(e=>{this.last_msg_time=e.stringTime,this.last_sent_message.firstElementChild.children[1].textContent=this.form_time(e.jsTime)}).catch(e=>{this.last_sent_message.children[1].style.color="red";let s=e.message,n=s.indexOf("HubException:");-1<n&&(s=s.substring(n+14)),app.alert(s)})}show_peers(e){let s=e.parentElement.parentElement;null!=this.open_peers&&this.open_peers.classList.remove("showpeers"),this.open_peers==s?this.open_peers=null:(this.open_peers=s,this.open_peers.classList.add("showpeers")),this.isdown&&setTimeout(()=>app.groupin.msgs_cont.scrollTop=app.groupin.msgs_cont.scrollHeight,20)}reply_click(e){let s=e.parentElement.parentElement,n=[];for(let t=0;t<s.children[2].children.length;t++)s.children[2].children[t].textContent!=app.name&&n.push(s.children[2].children[t].textContent);s.firstElementChild.children[3].textContent!=app.name&&n.push(s.firstElementChild.children[3].textContent);let t=!1;if(0<n.length)for(let e,s=0;s<this.onl_usr_panel.children.length;s++)if(e=n.indexOf(this.onl_usr_panel.children[s].textContent),-1<e){if(!t){t=!0,0<this.onl_usrs.size?(!0==this.is_cleared&&(this.is_cleared=!1,this.btn_swtch.firstElementChild.src="/images/cancel_sel.svg"),this.onl_usrs.clear()):this.btn_swtch.classList.remove("disabled");for(let e=0;e<this.onl_usr_panel.children.length;e++)this.onl_usr_panel.children[e].classList.remove("selected")}this.onl_usr_panel.children[s].classList.add("selected"),this.onl_usrs.add(this.onl_usr_panel.children[s]),n.splice(e,1)}t&&this.msgs_panel.children[2].focus()}async get_msgs(e=!1){if(!this.end_reached){let s=await app.api.get_grp_msgs(this.upper_msg_time,this.msgs_quantity);if(!(null!=s))this.msgs_loaded=!0,0==this.msg_pipe.length&&this.msg_input.removeAttribute("disabled");else if(!isNaN(s))0==s?(this.end_reached=!0,this.msgs_cont.style.opacity="1",this.msgs_loaded=!0,0==this.msg_pipe.length&&this.msg_input.removeAttribute("disabled")):(this.msgs_loaded=!0,0==this.msg_pipe.length&&this.msg_input.removeAttribute("disabled"),app.alert("Something went wrong, try to reload the page"));else if(Array.isArray(s)){s.length<this.msgs_quantity&&(this.end_reached=!0);let n=!1;this.end_reached||(this.upper_msg_time=s[0].stringTime),this.upper_msg_el||(this.last_msg_time=s[s.length-1].stringTime);let t=this.upper_msg_el,r=this.msgs_cont.scrollHeight;for(let e,r=0;r<s.length;r++){e=s[r],this.key&&(e.text=await this.decrypt(e.text));let l=this.form_msg(e);n||this.end_reached||(this.upper_msg_el=l,n=!0),t?this.msgs_cont.insertBefore(l,t):(this.msg_time.add(e.stringTime),this.msgs_cont.appendChild(l))}e?(clearTimeout(this.scroll_handle),this.scroll_handle=setTimeout(()=>{app.groupin.msgs_cont.scrollTop=app.groupin.msgs_cont.scrollHeight,app.groupin.msgs_cont.style.opacity="1"},200),this.msgs_cont.scrollHeight<3*this.msgs_cont.offsetHeight&&(await this.get_msgs(e)),this.msgs_loaded=!0,0==this.msg_pipe.length&&this.msg_input.removeAttribute("disabled")):r<this.msgs_cont.scrollHeight&&(this.msgs_cont.scrollTop=this.msgs_cont.scrollHeight-r)}else app.alert("Error. Server returned: "+s),this.msgs_loaded=!0,0==this.msg_pipe.length&&this.msg_input.removeAttribute("disabled")}}async get_missed_msgs(){let e=await app.api.get_missed_msgs(this.last_msg_time);if(e){if(!isNaN(e))-1==e&&app.alert("Limit exceeded. Try to reload the page.");else if(Array.isArray(e)){for(let s,n=0;n<e.length;n++)s=e[n],this.msg_time.add(s.stringTime),this.key&&(s.text=await this.decrypt(s.text)),this.msgs_cont.appendChild(this.form_msg(s));this.last_msg_time=e[e.length-1].stringTime,this.isdown&&(this.msgs_cont.scrollTop=this.msgs_cont.scrollHeight)}this.msgs_loaded=!0,0==this.msg_pipe.length&&this.msg_input.removeAttribute("disabled")}else this.msgs_loaded=!0,0==this.msg_pipe.length&&this.msg_input.removeAttribute("disabled")}scroll(){this.block_scroll||(this.msgs_cont.clientHeight+this.msgs_cont.scrollTop<this.msgs_cont.scrollHeight-50?(this.isdown=!1,this.msgs_cont.style.backgroundColor="white",0==this.msgs_cont.scrollTop&&this.get_msgs()):(this.isdown=!0,this.msgs_cont.style.backgroundColor="transparent"))}secret_onfocus(e){e.value=this.secret,e.placeholder=""}secret_onblur(e){e.placeholder="Secret Word or Phrase",e.value="";for(let s=0;s<this.secret.length;s++)e.value+="-"}secret_onkey(s,e){"Escape"==s.key?e.blur():"Enter"==s.key&&(e.value==this.secret?e.blur():(this.secret=e.value,e.blur(),this.reload_msgs()))}async reload_msgs(){this.key=this.secret?await this.toCryptoKey(this.secret):null,this.clear_msgs(),await this.get_msgs(!0)}async toCryptoKey(e){let s=this.textToArr(e),n=await crypto.subtle.digest("SHA-256",new Uint8Array(s));return await crypto.subtle.importKey("raw",new Uint8Array(n),"AES-CTR",!1,["encrypt","decrypt"])}textToArr(e){let s=[];for(let n=0;n<e.length;n++)s.push(e.charCodeAt(n));return s}async encrypt(e){if(this.key){let s=await crypto.subtle.encrypt({name:"AES-CTR",counter:new Uint8Array(16),length:128},this.key,this.encoder.encode(e));return String.fromCharCode(...new Uint8Array(s))}}async decrypt(e){if(this.key){let s=await crypto.subtle.decrypt({name:"AES-CTR",counter:new Uint8Array(16),length:128},this.key,new Uint8Array(this.textToArr(e)));return this.decoder.decode(new Uint8Array(s))}}notify(){return null==this.offl_usr?void 0:"granted"==Notification.permission?void app.api.push(this.offl_usr.textContent).then(e=>{e&&app.alert("User "+this.offl_usr.textContent+" has been invited"),this.offl_usr.classList.remove("selected"),this.btn_notif.classList.add("disabled"),this.offl_usr=null}):void app.alert("For you to be able to send notifications, you have to allow notifications for this web page in your browser's settings.")}sound_toggle(){this.sound_on?(this.btn_sound.firstElementChild.src="/images/sound_off.svg",this.sound_on=!1):(this.btn_sound.firstElementChild.src="/images/sound_on.svg",this.sound_on=!0)}}class app_class{constructor(){window.addEventListener("resize",()=>this.on_resize()),this.alert_el=document.getElementById("message"),this.alert_btn=this.alert_el.firstElementChild.children[1],this.alert_btn.onclick=this.alert_hide,this.alert_active=!1,this.wait_count=0,this.wait_handle=null,this.wait_el=document.getElementById("wait"),this.page=null,this.name=null,this.group=null,this.ingroup=null,this.pub_key=null,this.api=new api_class,this.reg_panel=new reg_panel_class,this.groups=new groups_class,this.groupin=new ingroup_class,setTimeout(()=>{this.api.usr_info().then(e=>{e&&(this.ingroup?this.goto("ingroup"):this.goto("groups"))})},1300),this.message={password:e=>e+" must be at least 8 characters long and maximum 32",name:e=>e+" must be at least 5 characters long and maximum 64"},navigator.permissions.query({name:"notifications"}).then(e=>e.onchange=()=>app.notif_perm_changed()),document.addEventListener("keydown",this.key_pressed)}key_pressed(s){if(!app.alert_active&&("Enter"==s.key||"Escape"==s.key&&!s.repeat))switch(app.page){case"reg":app.reg_panel.cntrl_key(s.key);break;case"groups":app.groups.cntrl_key(s.key);}}get pkey_array(){const e=" ".repeat(4-this.pub_key.length%4),s=(this.pub_key+e).replace(/\-/g,"+").replace(/_/g,"/");return new Uint8Array(Array.from(atob(s),e=>e.charCodeAt(0)))}on_resize(){switch(this.page){case"groups":this.groups.groups_resize();break;case"ingroup":this.groupin.ingroup_resize();}}wait(){1==++this.wait_count&&(this.wait_handle=setTimeout(()=>{app.wait_el.style.display="block",app.wait_el.focus()},50))}resume(){0==--this.wait_count&&(clearTimeout(this.wait_handle),this.wait_el.style.display="none")}alert(e){this.alert_active=!0,app.alert_el.style.display="block",app.alert_el.focus(),setTimeout(()=>app.alert_btn.focus(),150),app.alert_el.firstElementChild.firstElementChild.textContent=e}alert_hide(){app.alert_el.style.display="none",app.alert_active=!1}fail(e){document.cookie="Auth_Tok=; expires=Thu, 01 Jan 1970 00:00:00 UTC; path=/;",app.name=null,app.group=null,app.ingroup=null,app.goto("reg"),e&&app.alert(e)}goto(e){if(this.page!=e)switch(e){case"reg":this.groupin.secret=null,document.body.children[0].style.display="block",document.body.children[0].focus(),this.hide("reg");break;case"groups":this.groupin.secret=null,this.groups.list_clear(),this.groups.list_load(),this.groups.groups_window.getElementsByTagName("code")[0].textContent=this.name,this.groups.groups_window.getElementsByTagName("code")[0].title=this.name,document.body.children[1].style.display="block",document.body.children[1].focus(),this.groups.initialize(),this.hide("groups");break;case"ingroup":switch(Notification.permission){case"default":this.alert_btn.onclick=()=>this.proceed_ingroup(!0),this.alert("Shortly you'll be prompted to allow this website send you push notifications. In order to allow group users send you notifications and for you to be able to notify them, please allow.");break;case"denied":this.alert_btn.onclick=()=>this.proceed_ingroup(),this.alert("Your notifications are disabled. To be able to receive and send group notifications, please enable notifications in your browser settings for this website");break;case"granted":this.load_ingroup();}}}proceed_ingroup(e=!1){this.alert_hide(),this.alert_btn.onclick=()=>this.alert_hide(),e?Notification.requestPermission().then(()=>this.load_ingroup()):this.load_ingroup()}load_ingroup(){app.notif_subscribe(),app.groupin.connection.start().then(()=>{app.groupin.init(),app.groupin.usrs_panel.children[1].textContent=app.name,app.groupin.open_btn.nextElementSibling.textContent=app.ingroup,app.groupin.open_btn.nextElementSibling.title="In Group: "+app.ingroup,document.body.children[2].style.display="block",document.body.children[2].focus(),document.addEventListener("visibilitychange",app.visib_change),app.hide("ingroup")})}hide(e){switch(this.page){case"reg":document.body.children[0].style.display="none";try{app.reg_panel.goto("home")}catch(e){}break;case"groups":document.body.children[1].style.display="none",this.groups.groups_window.children[2].children[1].value=null,this.groups.query="";break;case"ingroup":this.groupin.connection.stop().then(()=>{app.groupin.leave(!0),document.body.children[2].style.display="none",document.removeEventListener("visibilitychange",this.visib_change)});}this.page=e}validatePassword(e){return!(!e||8>e.length||32<e.length)}validateName(e){return!(!e||5>e.length||64<e.length)}visib_change(){switch(document.visibilityState){case"hidden":app.groupin.connection.stop().catch(e=>app.alert(e));break;case"visible":app.groupin.connection.start().then(()=>app.groupin.init()).catch(e=>app.alert(e));}}async notif_subscribe(){if("granted"==Notification.permission)try{let e,s=await notif_worker.pushManager.getSubscription();s?(e=await app.api.subscribe(s),!e&&(s.unsubscribe(),app.fail())):(s=await notif_worker.pushManager.subscribe({userVisibleOnly:!0,applicationServerKey:this.pkey_array}),s?(e=await app.api.subscribe(s),!e&&(s.unsubscribe(),app.fail())):app.fail("System failed"))}catch(e){app.fail(e.message)}else app.api.unsubscribe()}notif_perm_changed(){window.location.reload()}}